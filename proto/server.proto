syntax = "proto3";

import "core.proto";

package server;

message ServerUpdate {
  int64 date = 1;
  int32 seq = 2;
  reserved 3;

  oneof update {
    // Chat updates

    ServerChatUpdateNewMessage new_message = 4;
    ServerChatUpdateEditMessage edit_message = 5;
    ServerChatUpdateDeleteMessages delete_messages = 6;
    ServerChatUpdateDeleteChat delete_chat = 7;
    ServerChatUpdateParticipantDelete participant_delete = 8;
    ServerChatUpdateNewChat new_chat = 18;
    ServerChatUpdateVisibility chat_visibility = 13;
    ServerChatUpdateInfo chat_info = 15;
    ServerChatUpdatePinnedMessages pinned_messages = 16;
    ServerChatUpdateMoved chat_moved = 21;

    // Space updates
    ServerSpaceUpdateRemoveMember space_remove_member = 9;
    ServerSpaceUpdateMemberUpdate space_member_update = 12;
    ServerSpaceUpdateMemberAdd space_member_add = 19;

    // User bucket updates
    ServerUserUpdateSpaceMemberDelete user_space_member_delete = 10;
    ServerUserUpdateChatParticipantDelete user_chat_participant_delete = 11;
    ServerUserUpdateDialogArchived user_dialog_archived = 14;
    ServerUserUpdateJoinSpace user_join_space = 17;
    ServerUserUpdateReadMaxId user_read_max_id = 20;
    ServerUserUpdateMarkAsUnread user_mark_as_unread = 22;
  }
}

// ------------------------------------------------------------
// Chat updates
// ------------------------------------------------------------

// Update for a chat when a message is created
message ServerChatUpdateNewMessage {
  int64 chat_id = 1;
  int64 msg_id = 2;
}

// Update for a chat when a message is edited
message ServerChatUpdateEditMessage {
  int64 chat_id = 1;
  int64 msg_id = 2;
}

// Update for a chat when messages are deleted
message ServerChatUpdateDeleteMessages {
  int64 chat_id = 1;
  repeated int64 msg_ids = 2;
}

// Update for a chat when it is deleted
message ServerChatUpdateDeleteChat { int64 chat_id = 1; }

// Update for a chat when it is created
message ServerChatUpdateNewChat { int64 chat_id = 1; }

// Update for a chat when a participant is removed
message ServerChatUpdateParticipantDelete {
  int64 chat_id = 1;
  int64 user_id = 2;
}

// Update for a chat when visibility changes
message ServerChatUpdateVisibility {
  int64 chat_id = 1;
  bool is_public = 2;
}

// Update for a chat when pinned messages change
message ServerChatUpdatePinnedMessages {
  int64 chat_id = 1;
  repeated int64 message_ids = 2;
}

// Update for a chat when title or emoji changes
message ServerChatUpdateInfo {
  int64 chat_id = 1;
  optional string title = 2;
  optional string emoji = 3;
}

// Update for a chat when the thread moves between home and a space.
//
// NOTE: v1 supports only private threads and only home <-> space moves.
// Keep the old/new space IDs for future cross-space moves.
message ServerChatUpdateMoved {
  int64 chat_id = 1;
  optional int64 old_space_id = 2;
  optional int64 new_space_id = 3;
}

// ------------------------------------------------------------
// Space updates
// ------------------------------------------------------------

// Update for a space when a member is removed
message ServerSpaceUpdateRemoveMember {
  int64 space_id = 1;
  int64 user_id = 2;
}

// Update for a space when a member's access/role changes
message ServerSpaceUpdateMemberUpdate { Member member = 1; }

// Update for a space when a new member is added
message ServerSpaceUpdateMemberAdd {
  Member member = 1;
  User user = 2;
}

// ------------------------------------------------------------
// User bucket updates
// ------------------------------------------------------------

// Update for a user when they were removed from a space
message ServerUserUpdateSpaceMemberDelete { int64 space_id = 1; }

// Update for a user when they were removed from a chat
message ServerUserUpdateChatParticipantDelete { int64 chat_id = 1; }

// Update for a user when a dialog is archived or unarchived
message ServerUserUpdateDialogArchived {
  Peer peer_id = 1;
  bool archived = 2;
}

// Update for a user when they joined a space
message ServerUserUpdateJoinSpace {
  Space space = 1;
  Member member = 2;
}

// Update for a user when they read messages up to a certain ID in a dialog.
//
// This is stored in the user bucket so read state can be repaired via catch-up after reconnect.
message ServerUserUpdateReadMaxId {
  Peer peer_id = 1;
  int64 read_max_id = 2;
  int32 unread_count = 3;
}

// Update for a user when a dialog is marked/unmarked as unread.
message ServerUserUpdateMarkAsUnread {
  Peer peer_id = 1;
  bool unread_mark = 2;
}
